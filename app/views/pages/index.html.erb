<% provide(:title, 'Home') %>
<% if current_user && !current_user.admin %>
  <div class="jumbotron" style="text-align: center">
    <p>Welcome <%= current_user.name.split[0] %>! </p>
    <p>All data should now have been submitted for <b><%= date_of_last("Sunday").strftime('%d-%b-%y') %></b></p>
    <% if current_user.is_leader? %>
      <% @current_user.church_groups.each do |group| %>
        <p><%= link_to "View #{group.name}", church_group_path(group), class: "btn btn-primary btn-xs" %></p>  
      <% end %>
      <% if current_user.churches.count > 0 %>
        <p><%= link_to "View Campus Church Data", records_path, class: "btn btn-primary btn-xs" %></p> 
       <% end %>
    <% else %>
      <p><%= link_to "View Data", records_path, class: "btn btn-primary btn-xs" %></p> 
    <% end %>
  </div>
<% elsif current_user && current_user.admin %>
  <div ng-app='DashBoard' class="container dashboard">
    <div class="dashboard_heading">
      <h2> Summary </h2>
      <div>
        <span>
          <%= fa_icon "calendar-check-o" %>
          <%= Date.today.strftime("%d %b %Y") %>
        </span>
      </div>
    </div>
    <div ng-controller='CardListCtrl'>
      <div class='modal_layer' ng-click='closeModal()' ng-show='modalShow'></div>
      <div class='modal_box' ng-show='modalShow'>
        <%= fa_icon "close pull-right", class: "fa-2x", "ng-click" => "closeModal()" %>
        <h3>{{modalHeader}}</h3>
        <span>{{chosenCard.name}}</span>
        <hr />
        <div ng-show="detailLoading" class='loading' id="detailloader">
          <i class="fa fa-spinner fa-spin fa-3x" aria-hidden="true"></i>
          ... Loading Chart Data
        </div>
        <div id="chartContainer" ng-hide="detailLoading" style="position: absolute; top: 100px; left: 0; right: 0; height: 400px"></div>
      </div>
      <div ng-show="loading" class='loading'>
        <i class="fa fa-spinner fa-spin fa-3x" aria-hidden="true" ng-show='loading'></i>
        ... Loading
      </div>
      <div ng-hide='loading' class="section_heading" >
        <h3> Quick Stats </h3>
      </div>
      <div ng-hide='loading' class="quick_stats">
        <section class='card_actions' ng-hide="loading">
          <button ng-click="filterToggle()" class="filterToggle">Show / Hide Filters</button>
          <ul>
            <li ng-hide='filterHide'>
              <select ng-model="main_choice_by">
                  <option value="">Select Grouping</option>
                  <option value="Region">Region</option>
                  <option value="Church Group">Church Group</option>
                  <option value="City">City</option>
                  <option value="Church">Church</option>
              </select>
            </li>
            <li ng-hide="filterHide  || main_choice_by !== 'Region'">
              <select ng-change="reloadData()" ng-model="search">
                <% @regions.each do |region| %>
                  <option value="region:<%= region %>"><%= region %></option>
                <% end %>
                <option value=''>Select Region</option>
              </select>
            </li>
            <li ng-hide="filterHide  || main_choice_by !== 'Church Group'">
              <select ng-change="reloadData()" ng-model="search">
                <% @church_groups.each do |group| %>
                  <option value="church_group:<%= group.name %>"><%= group.leader.name.split(" ")[0] + "- " + group.name %></option>
                <% end %>
                <option value=''>Select Church Group</option>
              </select>
            </li>
            <li ng-hide="filterHide  || main_choice_by !== 'City'">
              <select ng-change="reloadData()" ng-model="search">
                <% @cities.each do |city| %>
                  <option value="city:<%= city %>"><%= city %></option>
                <% end %>
                <option value=''>Select City</option>
              </select>
            </li>
            <li ng-hide="filterHide  || main_choice_by !== 'Church'">
              <select ng-change="reloadData()" ng-model="search">
                <% @churches.each do |church| %>
                  <option value="church:<%= church %>"><%= church %></option>
                <% end %>
                <option value=''>Select Church</option>
              </select>
            </li>
            <li ng-hide='filterHide'><button ng-click="search = ''; reloadData()"> Reset Data </button></li>
          </ul>
        </section>
        <div>
          <div ng-repeat="card in cards">
            <%= render "info_box" %>
          </div>
        </div>
      </div>
      <div ng-hide='loading' class="section_heading">
        <h3> Search Data </h3>
      </div>
      <div id="search_data">
        <section class='card_actions' ng-hide="loading">
          <button ng-click="searchFilterToggle()" class="filterToggle">Show / Hide Search Params</button>
          <ul>
            <li ng-hide='searchFilterHide'>
              <div class='form-group'>
                <label for="start_date">Date From:</label>
                <input type='date' class='datepick' name="start_date" ng-model='start_date' ng-change="updateDate()" value="<%= (Date.today - 7).strftime('%Y-%m-%d') %>" />
              </div>
            </li>
            <li ng-hide='searchFilterHide' >
              <div class='form-group'>
                <label for="end_date">Date To:</label>
                <input type='date' class='datepick' ng-model='end_date' ng-change="updateDate()" name="end_date" value="<%= Date.today.strftime('%Y-%m-%d') %>" />
              </div>
            </li>
            <li ng-hide='searchFilterHide'>
              <select ng-model="choice_by" ng-change="getAllCard()">
                  <option value="">Select Grouping</option>
                  <option value="all">All UK</option>
                  <option value="Region">Region</option>
                  <option value="Church Group">Church Group</option>
                  <option value="City">City</option>
                  <option value="Church">Church</option>
              </select>
            </li>
            <li ng-hide="searchFilterHide || choice_by !=='Region'">
              <select ng-change="searchData()" ng-model="searchTerm">
                <% @regions.each do |region| %>
                  <option value="region:<%= region %>"><%= region %></option>
                <% end %>
                <option value=''>All Regions</option>
              </select>
            </li>
            <li ng-hide="searchFilterHide || choice_by !=='Church Group'">
              <select ng-change="searchData()" ng-model="searchTerm">
                <% @church_groups.each do |group| %>
                  <option value="church_group:<%= group.name %>"><%= group.leader.name.split(" ")[0] + "- " + group.name %></option>
                <% end %>
                <option value=''>All Church Groups</option>
              </select>
            </li>
            <li ng-hide="searchFilterHide || choice_by !=='City'">
              <select ng-change="searchData()" ng-model="searchTerm">
                <% @cities.each do |city| %>
                  <option value="city:<%= city %>"><%= city %></option>
                <% end %>
                <option value=''>All Cities</option>
              </select>
            </li>
            <li ng-hide="searchFilterHide || choice_by !=='Church'">
              <select ng-change="searchData()" ng-model="searchTerm">
                <% @churches.each do |church| %>
                  <option value="church:<%= church %>"><%= church %></option>
                <% end %>
                <option value=''>All Churchs</option>
              </select>
            </li>
          </ul>
        </section>
        <div class="quick_stats">
            <div ng-show="hasSearched">
              <%= render "info_box" %>
            </div>
        </div>
      </div>

      <div ng-hide='loading' class="section_heading">
        <h3> FLC UK Overview </h3>
      </div>
      <div ng-hide='loading' id='overview'>
        <%= render 'overview' %>
      </div>
    </div>
  </div>
<% end %>